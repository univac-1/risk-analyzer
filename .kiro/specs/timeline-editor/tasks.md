# Implementation Plan

## Tasks

- [ ] 1. データモデルとDBマイグレーション
- [x] 1.1 編集セッション・アクション・エクスポートジョブのデータベーススキーマを作成する
  - EditSession, EditAction, ExportJobの3テーブルを定義
  - 外部キー制約とインデックスを設定
  - Alembicマイグレーションファイルを生成・実行
  - _Requirements: 6.1, 7.2, 7.3, 8.1_

- [x] 1.2 (P) SQLAlchemyモデルを作成する
  - EditSession, EditAction, ExportJobのORMモデルを定義
  - リレーションシップとカスケード削除を設定
  - ステータス列挙型を定義（draft/exporting/completed等）
  - _Requirements: 6.1, 8.1_

- [x] 1.3 (P) Pydanticスキーマを作成する
  - リクエスト・レスポンス用のスキーマを定義
  - EditActionInput, MosaicOptions, TelopOptionsを含む
  - バリデーションルールを設定
  - _Requirements: 6.1, 6.3, 6.4_

- [x] 2. バックエンドAPI基盤
- [x] 2.1 編集セッションサービスを実装する
  - セッションの取得・作成・更新のCRUD操作
  - 編集アクションの追加・削除・更新
  - ジョブIDからの関連データ取得
  - _Requirements: 6.1, 7.2, 7.3_

- [x] 2.2 動画URL取得APIを実装する
  - 既存storage.pyのpresigned_url機能を利用
  - ジョブIDから元動画のURLを生成
  - 有効期限を1時間に設定
  - _Requirements: 1.1, 1.5_

- [x] 2.3 編集セッションAPIを実装する
  - GET /api/jobs/{job_id}/edit-session
  - PUT /api/jobs/{job_id}/edit-session
  - セッション自動作成（存在しない場合）
  - _Requirements: 6.1, 7.2, 7.3_

- [x] 3. FFmpeg動画編集サービス
- [x] 3.1 FFmpegフィルターチェーン生成機能を実装する
  - 編集アクションからフィルター式を生成
  - カット: select/aselectフィルター
  - ミュート: volumeフィルター
  - モザイク: boxblurフィルター
  - テロップ: drawtextフィルター
  - 複数アクションの統合（フィルター順序: カット→ミュート→モザイク→テロップ）
  - _Requirements: 8.2_

- [x] 3.2 FFmpeg実行と進捗取得機能を実装する
  - サブプロセスでFFmpegを実行
  - -progressオプションで進捗をパイプ出力
  - frame=行をパースして進捗率を計算
  - コールバック関数で進捗を通知
  - _Requirements: 8.2, 8.3_

- [x] 3.3 日本語テロップ対応を実装する
  - Noto Sans JPフォントのパス指定
  - UTF-8テキストのエスケープ処理
  - フォントサイズ・色・位置の設定
  - _Requirements: 8.2_

- [x] 4. エクスポートタスク
- [x] 4.1 Celeryエクスポートタスクを実装する
  - MinIOから元動画をダウンロード
  - VideoEditorServiceで編集実行
  - 編集済み動画をMinIOにアップロード
  - ExportJobステータスを更新
  - _Requirements: 8.1, 8.5, 8.6_

- [x] 4.2 エクスポート進捗のRedis管理を実装する
  - 進捗情報をRedisに保存
  - ステータス: pending/processing/completed/failed
  - 進捗率とエラーメッセージの管理
  - _Requirements: 8.3, 8.4_

- [x] 4.3 エクスポートAPIを実装する
  - POST /api/jobs/{job_id}/export（エクスポート開始）
  - GET /api/jobs/{job_id}/export/status（進捗取得）
  - GET /api/jobs/{job_id}/export/download（ダウンロードURL取得）
  - エクスポート中の重複実行防止
  - _Requirements: 8.1, 8.3, 8.4, 8.5_

- [x] 5. フロントエンド基盤
- [x] 5.1 (P) エディタ用型定義を作成する
  - EditSession, EditAction, ExportStatusの型
  - MosaicOptions, TelopOptionsの型
  - APIレスポンス型
  - _Requirements: 6.1_

- [x] 5.2 (P) エディタ用APIクライアントを実装する
  - 動画URL取得
  - 編集セッションCRUD
  - エクスポート開始・進捗取得・ダウンロード
  - _Requirements: 1.1, 6.1, 7.2, 7.3, 8.1_

- [x] 5.3 編集セッション管理フックを実装する
  - useEditSessionフック
  - 編集アクションの追加・削除・更新
  - Undo機能（最大20件の履歴）
  - APIとの同期
  - _Requirements: 6.1, 6.6_

- [x] 6. 動画プレビューコンポーネント
- [x] 6.1 動画プレビュー表示を実装する
  - video要素でアスペクト比維持の中央表示
  - 現在再生時刻のオーバーレイ表示（M:SS.s形式）
  - 動画URLが未設定時のプレースホルダー
  - _Requirements: 1.1, 1.2, 1.3, 1.5_

- [x] 6.2 カット範囲オーバーレイを実装する
  - 再生位置がカット範囲内にある場合のオーバーレイ表示
  - 「この部分はカットされます」メッセージ
  - カット時間範囲の表示
  - _Requirements: 1.4_

- [x] 7. 再生コントロールコンポーネント
- [x] 7.1 基本再生コントロールを実装する
  - 再生/一時停止ボタン
  - 5秒戻る/5秒進むスキップボタン
  - 現在時刻と総再生時間の表示（M:SS / M:SS形式）
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 7.2 シークバーと追加コントロールを実装する
  - シークバー（スライダー）で任意の位置にジャンプ
  - 音量調整ボタン
  - フルスクリーン切替ボタン
  - _Requirements: 2.3, 2.5, 2.6_

- [x] 8. リスクスコアグラフコンポーネント
- [x] 8.1 リスクスコアグラフを実装する
  - 時間軸に沿ったリスクスコアグラフをSVGで表示
  - リスクレベルに応じたグラデーション塗りつぶし（高:赤、中:黄、低:緑）
  - 高リスク区間（70%以上）の背景ハイライト
  - 0%と100%のラベル、30%と70%の補助グリッド線
  - _Requirements: 3.1, 3.2, 3.3, 3.6, 3.7_

- [x] 8.2 再生位置インジケーターを実装する
  - 現在再生位置を縦線インジケーターで表示
  - 現在位置のリスクレベルを数値で表示（例: 「現在: 85%」）
  - _Requirements: 3.4, 3.5_

- [x] 9. タイムラインコンポーネント
- [x] 9.1 タイムライン基本表示を実装する
  - 動画の長さに応じたタイムマーカーを等間隔で表示
  - 現在の再生位置を再生ヘッド（縦線+上下の円形ハンドル）で表示
  - クリック/ドラッグ操作で再生位置をシーク
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 9.2 編集範囲表示を実装する
  - カット適用済み範囲を赤色（destructive）で表示
  - AI提案範囲を黄色（warning）で表示
  - 提案範囲クリックで該当提案を選択状態に
  - 選択状態の強調表示（border + 明るい背景色）
  - _Requirements: 4.4, 4.5, 4.6, 4.7_

- [x] 10. 編集提案パネルコンポーネント
- [x] 10.1 編集提案パネル基本表示を実装する
  - サイドバーとして表示（デスクトップ: 右側固定）
  - 検出された高リスク箇所の件数表示
  - 各提案をカード形式で表示
  - カードにリスクレベルバッジ、時間範囲、リスクの理由を表示
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 10.2 提案カードのインタラクションを実装する
  - カードクリックで選択状態にしタイムライン上で強調表示
  - 「プレビュー」ボタンで該当時間位置にシーク
  - 「カット適用」ボタンで該当範囲をカット対象として登録
  - 「すべての提案を適用」ボタン
  - _Requirements: 5.5, 5.6, 5.7, 5.8, 5.9, 5.10_

- [x] 10.3 編集アクション選択UIを実装する
  - カット、ミュート、モザイク、テロップ、対応しないの選択肢
  - ミュート選択時: 該当区間を音声無音化対象としてマーク
  - モザイク選択時: モザイク適用領域を指定するUI
  - テロップ選択時: テロップ内容を入力するUI
  - 対応しない選択時: スキップ済みとしてマーク
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 11. ヘッダーとメインレイアウト
- [x] 11.1 タイムラインエディタのメインレイアウトを実装する
  - エディタ全体のレイアウト管理
  - 子コンポーネントへの状態配布
  - 編集セッションの保存・復元トリガー
  - _Requirements: 1.1, 7.1_

- [x] 11.2 ヘッダーアクションを実装する
  - 「動画をアップロード」ボタン
  - 「保存」ボタン（編集セッションの状態を保存）
  - 「エクスポート」ボタン（編集内容を適用した動画の生成開始）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 11.3 エクスポート進捗表示を実装する
  - 編集処理実行中の進捗状況表示
  - エラー時のエラー内容表示と再試行オプション
  - 完了時の編集済み動画ダウンロードリンク
  - _Requirements: 8.3, 8.4, 8.5_

- [ ] 12. レスポンシブ対応
- [ ] 12.1 モバイルレイアウトを実装する
  - デスクトップとモバイルで異なるレイアウト
  - モバイル: 編集提案パネルをアコーディオン形式で表示
  - モバイル: ハンバーガーメニューでサイドバーを切り替え
  - モバイル: ヘッダーのボタンラベルを非表示にしアイコンのみ表示
  - タイムライン・リスクグラフエリアの高さ調整（モバイル: h-48、デスクトップ: h-64）
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 13. ルーティングと統合
- [ ] 13.1 エディタページとルーティングを設定する
  - /editor/{jobId}ルートの追加
  - ジョブ一覧からエディタへの導線
  - 編集完了後のナビゲーション
  - _Requirements: 1.1_

- [ ] 13.2 全コンポーネントの統合テストを実施する
  - 編集アクション追加→保存→再読み込みの動作確認
  - エクスポート実行→進捗表示→ダウンロードの動作確認
  - エラーハンドリングの確認
  - _Requirements: 1.1, 6.1, 7.2, 7.3, 8.1, 8.3, 8.4, 8.5_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1 (動画プレビュー画面) | 2.2, 6.1, 6.2, 11.1, 13.1 |
| 2 (動画再生コントロール) | 7.1, 7.2 |
| 3 (リスクスコアグラフ) | 8.1, 8.2 |
| 4 (タイムライン) | 9.1, 9.2 |
| 5 (編集提案パネル) | 10.1, 10.2 |
| 6 (編集アクション拡張) | 1.1, 1.2, 1.3, 2.1, 2.3, 5.1, 5.2, 5.3, 10.3 |
| 7 (ヘッダーアクション) | 2.1, 2.3, 5.2, 5.3, 11.2 |
| 8 (動画編集処理) | 1.1, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 11.3 |
| 9 (レスポンシブ対応) | 12.1 |
