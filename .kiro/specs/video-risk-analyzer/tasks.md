# Implementation Plan

## Tasks

- [x] 1. プロジェクト基盤セットアップ
- [x] 1.1 Docker Compose環境の構築
  - マルチコンテナ構成（frontend, backend, worker, redis, db, minio）を定義
  - サービス間の依存関係とヘルスチェックを設定
  - 環境変数テンプレート（.env.example）を作成
  - ボリューム永続化を設定
  - _Requirements: 8.1, 8.2_

- [x] 1.2 (P) バックエンドプロジェクトの初期化
  - FastAPIアプリケーションの雛形を作成
  - Poetry依存管理の設定（pyproject.toml）
  - 設定管理モジュールを実装（環境変数読み込み）
  - CORSミドルウェアを設定
  - _Requirements: 1.1_

- [x] 1.3 (P) フロントエンドプロジェクトの初期化
  - React + TypeScript + Viteのプロジェクトを作成
  - 基本的なルーティング構成を設定
  - API通信用のHTTPクライアントを設定
  - 共通UIコンポーネントのディレクトリ構成を作成
  - _Requirements: 1.1_

- [x] 1.4 データベースセットアップ
  - SQLAlchemy + Alembicの設定
  - データベース接続管理を実装
  - 初期マイグレーションを作成
  - _Requirements: 8.1_

- [x] 2. 非同期タスク処理基盤
- [x] 2.1 Celery設定とワーカーの構築
  - CeleryアプリケーションをRedisブローカーで設定
  - ワーカープロセスの起動設定
  - タスクのリトライポリシーを定義
  - _Requirements: 8.1, 8.2_

- [x] 2.2 進捗管理サービスの実装
  - Redis経由でフェーズ別進捗を更新・取得する機能
  - 総合進捗率の計算ロジック
  - 推定残り時間の算出
  - ジョブ完了・失敗状態の設定機能
  - _Requirements: 7.1, 7.2, 7.3, 8.4_

- [x] 3. ファイルストレージとアップロード機能
- [x] 3.1 オブジェクトストレージ連携の実装
  - MinIO（ローカル）/ GCS（本番）への抽象化レイヤー
  - ファイルアップロード・ダウンロード機能
  - 署名付きURL生成
  - _Requirements: 1.1, 1.5_

- [x] 3.2 動画アップロードAPIの実装
  - multipart/form-dataでの動画受付
  - mp4形式バリデーション（拡張子・MIMEタイプ）
  - ファイルサイズ上限チェック
  - メタ情報（用途・投稿先媒体・想定ターゲット）の検証
  - ストレージへの保存とファイルパス返却
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 3.3 ジョブ管理データモデルの実装
  - AnalysisJobモデル（ステータス、メタデータ、タイムスタンプ）
  - Videoモデル（ファイルパス、サイズ、動画長）
  - ステータス遷移ロジック（pending → processing → completed/failed）
  - _Requirements: 8.1, 8.4, 8.6_

- [x] 3.4 動画アップロード時のタスク登録
  - アップロード完了後にジョブレコードを作成
  - Celeryタスクを登録して解析を開始
  - ジョブIDを即座に返却（202 Accepted）
  - _Requirements: 1.5, 8.1_

- [x] 4. 音声解析機能
- [x] 4.1 動画から音声を抽出する機能の実装
  - ffmpegを使用した音声トラック抽出
  - 一時ファイル管理と後処理
  - _Requirements: 2.1_

- [x] 4.2 Speech-to-Text APIによる文字起こしの実装
  - Google Cloud Speech-to-Text API（Chirp 2モデル）との連携
  - 話者分離（Speaker Diarization）機能の利用
  - タイムコード付きトランスクリプト生成
  - 音声なし検出時のグレースフルハンドリング
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 5. OCR解析機能
- [x] 5.1 Video Intelligence APIによるテキスト抽出の実装
  - Google Cloud Video Intelligence APIとの連携
  - 動画フレームからのテキスト検出
  - タイムコードと位置情報（バウンディングボックス）付きでテキスト抽出
  - テキストなし検出時のグレースフルハンドリング
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 6. 映像内容解析機能
- [x] 6.1 Gemini APIによる映像解析の実装
  - フレームサンプリングと画像抽出
  - Vertex AI Gemini APIへのマルチモーダルリクエスト
  - 人物・物体・行動の検出とタイムコード付与
  - 表情・ジェスチャー・服装などの視覚的特徴の記録
  - シーン状況（場所・雰囲気・コンテキスト）の分類
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 7. リスク評価機能
- [x] 7.1 リスク評価エンジンの実装
  - 音声・OCR・映像の解析結果を統合
  - メタ情報（投稿先媒体・想定ターゲット）を評価に反映
  - Gemini APIを用いたリスク推論
  - _Requirements: 5.1, 5.2_

- [x] 7.2 3観点リスク検出ロジックの実装
  - 攻撃性の検出（匿名性・拡散性・感情的反応・集団心理・個人攻撃）
  - 差別性の検出（人種・性別・性的指向への偏見）
  - 誤解を招く表現の検出（断定・曖昧・誇張・ステレオタイプ）
  - _Requirements: 5.5, 5.6, 5.7_

- [x] 7.3 リスクスコアリングと根拠生成
  - 各リスク箇所へのスコア（重要度）算出
  - リスク判断の具体的根拠を記述
  - タイムコードとソース（音声/OCR/映像）の紐付け
  - _Requirements: 5.3, 5.4_

- [x] 8. 解析オーケストレーション
- [x] 8.1 並列解析パイプラインの実装
  - AudioAnalyzer、OCRAnalyzer、VideoAnalyzerの並列実行
  - 各解析の完了待機と結果集約
  - フェーズ別進捗更新
  - _Requirements: 2.1, 3.1, 4.1, 7.2_

- [x] 8.2 統合リスク評価の実行
  - 全解析完了後にRiskEvaluatorを呼び出し
  - 結果をデータベースに保存
  - ジョブステータスを完了に更新
  - _Requirements: 5.1, 8.4_

- [x] 8.3 エラーハンドリングと部分失敗対応
  - 個別解析のエラー時に他解析を継続
  - 失敗時のリトライ処理
  - エラー詳細の記録とステータス更新
  - _Requirements: 2.3, 3.4, 7.4, 8.6_

- [x] 9. ジョブ管理API
- [x] 9.1 ジョブ一覧取得APIの実装
  - 全ジョブをステータス付きで一覧取得
  - 作成日時でのソート
  - _Requirements: 8.3_

- [x] 9.2 ジョブ詳細・進捗取得APIの実装
  - 個別ジョブの詳細情報を取得
  - フェーズ別進捗状況をRedisから取得
  - 推定残り時間を含む進捗ステータス返却
  - _Requirements: 7.1, 7.2, 7.3, 8.5_

- [x] 9.3 解析結果取得APIの実装
  - 完了ジョブの解析結果を取得
  - リスク箇所をタイムコード順に返却
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 9.4 SSEによるリアルタイム進捗配信の実装
  - Server-Sent Events エンドポイント
  - 進捗更新をリアルタイムでクライアントに配信
  - _Requirements: 7.1_

- [x] 10. フロントエンドUI実装
- [x] 10.1 動画アップロードコンポーネントの実装
  - ドラッグ&ドロップまたはファイル選択での動画受付
  - mp4形式のバリデーション表示
  - メタ情報入力フォーム（用途・投稿先媒体・想定ターゲット）
  - ファイルサイズ超過時のエラー表示
  - アップロード実行と進捗画面への遷移
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 10.2 (P) 進捗表示コンポーネントの実装
  - 全体進捗率の表示
  - 各解析フェーズ（音声・テキスト・映像・リスク評価）の個別進捗
  - 推定残り時間の表示
  - エラー発生時の表示と再試行オプション
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 10.3 (P) 結果表示コンポーネントの実装
  - リスク箇所のタイムコード順一覧表示
  - 各リスク箇所のタイムコード・リスク根拠・炎上スコア表示
  - リスクスコア順ソートオプション
  - リスクなし時のメッセージ表示
  - _Requirements: 6.1, 6.2, 6.3, 6.5, 6.6_

- [x] 10.4 (P) 動画プレビュー機能の実装
  - リスク箇所クリック時に該当タイムコードから再生
  - 動画プレーヤーコントロール
  - _Requirements: 6.4_

- [x] 10.5 ジョブ一覧コンポーネントの実装
  - 過去の解析ジョブ一覧表示
  - ステータス（待機中・処理中・完了・エラー）表示
  - ジョブ選択による詳細画面への遷移
  - _Requirements: 8.3, 8.4, 8.5_

- [x] 11. エンドツーエンド統合
- [x] 11.1 フロントエンドとバックエンドの結合
  - API呼び出しの接続確認
  - アップロードから結果表示までの一連フローの動作確認
  - SSE進捗通知の接続確認
  - _Requirements: 1.1, 6.1, 7.1, 8.1_

- [x] 11.2 統合テストの実装
  - 動画アップロードから結果取得までの自動テスト
  - 外部API（Speech-to-Text, Video Intelligence, Gemini）のモックテスト
  - エラーケースのテスト（無効ファイル、API障害）
  - _Requirements: 1.3, 1.4, 7.4, 8.6_

- [x] 11.3 セキュリティ対策の実装
  - Content-Type検証とマジックバイト検証
  - 解析完了後の一時ファイル自動削除
  - 環境変数によるAPIキー管理
  - _Requirements: 1.3_
